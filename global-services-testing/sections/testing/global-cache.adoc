[[global-cache-testing]]

=== Global Cache Service testing

==== Functional Tests

===== 1. MQTT Broker Connectivity

====== Purpose
An MQTT client must be able to connect to the local broker of the Global Cache on port 8883 using the MQTT protocol version 5 with TLS (i.e., mqtts protocol) and username/password authentication.

*Source:* Manual on WIS (WMO No. 1060), Vol II, clause 3.7.5.2: A Global Cache shall operate a message broker.

====== Requirements
* GC MQTT broker connection string
* MQTT Test Client

====== Steps

. Initialize the test MQTT client with the necessary parameters such as the MQTT protocol version 5, TLS security, and username/password for authentication (connection string).
. Attempt to connect the MQTT broker of the Global Cache using the connection string.

====== Evaluate

. Check if the connection is successful (rc code). If the connection is successful, the test passes. If the connection is not successful, the test fails.

===== 2. GC MQTT Broker Subscription

====== Purpose
A Global Cache must allow connected MQTT clients to subscribe to the ++cache/a/wis2/#++ topic using a provided connection string.

====== Requirements
* GC MQTT broker connection string
* MQTT Test Client

====== Steps

. Initialize a MQTT client with the necessary parameters such as the MQTT protocol version 5, TLS security, and username/password for authentication (connection string).
. Connect the MQTT client to the local broker of the Global Cache.
. Once the connection is successful, attempt to subscribe to the `cache/a/wis2/#` topic.

====== Evaluate

. Check if the subscription is successful. If the subscription is successful based on the returned rc code (SUBACK), the test passes. If the subscription is not successful, the test fails.
. Close the connection to the broker after the test.


===== 3. WIS2 Notification Message (WNM) Processing

====== Purpose
Test that the GC functions as expected under normal conditions. The Global Cache should process a valid incoming WNM, download the data at the provided canonical link, and publish a new WNM on the proper ++cache/++ topic using the proper message structure, and update the necessary GC metrics.

This test also evaluates the client data download requirement: An HTTP client (i.e., a Web browser) must be able to connect to the HTTP server of the Global Cache on port 443 using HTTP 1.1 with TLS but without any authentication and be able to resolve the URL provided in a data download link (a link object's `href` property where `rel=canonical`) from a notification message published by the Global Cache within the previous 24 hours; i.e., download a cached data item.

*Source:* Manual on WIS (WMO No. 1060), Vol II, clause 3.7.5.5: A Global Cache shall provide highly available access to copies of discovery metadata records and core data it stores; clause 3.7.5.6: A Global Cache shall retain a copy of the discovery metadata records and core data it stores for a duration compatible with the real-time or near-real-time schedule of the data and not less than 24 hours; clause 4.5.2: A Global Cache shall download core data and discovery metadata from [WIS2 Nodes] and other Global [Services] to provide for reliable, low-latency access to those resources via WIS; clause 4.5.6: Data and discovery metadata available for download from a Global Cache shall be accessible via a URL using at least one of the protocols specified [...].

*Source:* Manual on WIS (WMO No. 1060), Vol II, clause 3.7.5.4: Based on the notifications it receives, a Global Cache shall download and store a copy of discovery metadata records and core data from [WIS2 Nodes] and other Global [Services]; clause 3.7.5.7: A Global Cache shall publish notifications via its Message Broker about copies of the discovery metadata records and core data it makes available. A Global Cache shall use a standardized topic structure when publishing notifications; clause 4.5.2: A Global Cache shall download core data and discovery metadata from [WIS2 Nodes] and other Global [Services] to provide for reliable, low-latency access to those resources via WIS; clause 4.5.4: Based on received notifications, a Global Cache shall download core data from [WIS2 Nodes] or other Global [Services] and store them for a minimum duration of 24 hours; clause 4.5.5: Based on its received notifications, a Global Cache shall download discovery metadata records from [WIS2 Nodes] or other Global [Services] and store them for a minimum duration of 24 hours; clause 4.5.7: A Global Cache shall publish notifications to a Message Broker indicating  the availability of data and discovery metadata resources from the Global Cache and shall use the format and protocol specified [...].

*Source:* Guide to WIS (WMO No. 1061), Vol II, clause 2.7.4.1. [Global Cache] Technical considerations https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_technical_considerations_2; clause 2.7.4.2. [Global Cache] Practices and procedures https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_practices_and_procedures_2

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly).
* Dev/test GB MQTT broker connection string
    ** User is able to publish (write) messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated and connected to the dev/test GB with subscriptions to the following topics on the dev:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and associated data objects:
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's with:
    *** `properties.cache` set to true
    *** `properties.data_id` + `properties.pubtime` should be unique to each message. Ensuring a different data_id is best here.
  ** Accompanying data objects should be accessible via the canonical link provided in the WNM.
    *** The canonical link should be accessible per the core requirements and the data object hash should match the hash provided in the WNM if integrity properties are provided.

====== Steps

. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish a batch of Prepared WIS2 Notification Messages to the dev/test GB on following topics:
    ** Send 1 or more messages to origin/a/wis2/+/data
    ** Send 1 or more messages to cache/a/wis2/+/data
    ** Send 1 or more messages to origin/a/wis2/+/metadata
    ** Send 1 or more messages to cache/a/wis2/+/metadata
. The test MQTT client should store the messages received on the `cache/a/wis2/#` topic published by the GC and download the data objects from the canonical link provided in the messages using HTTP 1.1 with TLS.
    ** The original data object and the downloaded>>cached data objects can then be compared to ensure they are identical.

====== Evaluate
* WNM Messages
    ** The total number of cache notification messages published by the GC on the cache/a/wis2/# topic.
    ** All messages should be the same as the source WNM's except for:
        *** The canonical link (a link object's `href` property where `rel=canonical`), this should point to the GC's cached object.
        *** the unique identifier of the message (id)
        *** The topic, always on the `cache` channel. Note the incoming message may be unchanged if it was originally published on the `cache` channel.
* Data Objects
    ** The total number of data objects cached by the GC. This should match the number of cache notification messages published.
    ** The data objects cached by the GC should be identical to the source data objects.
        *** The diff or hashes of the data objects should be identical.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (matches total messages)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 1 for each)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (set for each and within expected time range)

===== 4. Cache False Directive
====== Purpose
Where a Global Cache receives a notification message with _properties.cache_ set to false, the Global Cache should publish a notification message where the data download link (a link object's `href` property where `rel=canonical`) refers to the source data server.

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects:
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's with:
    *** `properties.cache` set to #false#
    *** `properties.data_id` + `properties.pubtime` should be unique to each message.
  ** Accompanying data objects are not required for this test.

====== Steps

. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WIS2 Notification Messages to the dev/test GB the following topics:
    ** Send 1 or more messages to origin/a/wis2/+/data
    ** Send 1 or more messages to cache/a/wis2/+/data
    ** Send 1 or more messages to origin/a/wis2/+/metadata
    ** Send 1 or more messages to cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** The total number of cache notification messages published by the GC on the `cache/a/wis2/#` topic
    ** all messages should be the same as the source WNM's except for:
        *** the unique identifier of the message (id)
        *** the topic (`cache/a/wis2/...`) (note the incoming message may be on the same `cache/#` topic if it is from another GC)
* GC Metrics
  ** `wmo_wis2_gc_download_total` (unchanged)
  ** `wmo_wis2_gc_dataserver_status_flag` (unchanged)
  ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (unchanged)
  ** `wmo_wis2_gc_no_cache_total` (+=1 for each WNM)

===== 5. Source Download Failure
====== Purpose
Where a Global Cache receives a valid WNM, but is unable to download a data item from the location specified in a notification message (i.e., the source data server), the `metric wmo_wis2_gc_dataserver_status_flag` for the source data server should be set to 0 (zero).

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's with:
    *** #invalid# data download links (a link object's `href` property where `rel=canonical`)
    *** `properties.data_id` + `properties.pubtime` should be unique to each message.
  ** Accompanying data objects are not required for this test.

====== Steps

. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WNM's to the dev/test GB on one or more of the following topics:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** No messages should be published on the `cache/a/wis2/#` topic as received by the test MQTT client.
* Data Objects
    ** No data objects should be cached by the GC.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (unchanged)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 0 for each)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (unchanged)
    ** `wmo_wis2_gc_downloaded_errors_total` (+=1 for each WNM)

===== 6. Cache Override (Optional)
====== Purpose
Where a Global Cache determines that it is unable to cache a data item, the Global Cache should publish a notification message where the data download link (a link object's `href` property where `rel=canonical`) refers to the source data server, and the metric `wmo_wis2_gc_cache_override_total` is incremented by 1 (one).
Note that the trigger for this directive is implementation specific. The criteria must be known and enabled for the test
to be valid. Additionally, a given GC may decide to NOT implement this directive and thus this test is included as optional.

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's with:
    *** `properties.cache` set to #true#
    *** `properties.data_id` + `properties.pubtime` should be unique to each message.
    *** #The known properties that trigger the cache override directive.#
  ** Accompanying data objects are not required for this test.

====== Steps

. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the perpared WNM's to the dev/test GB on one or more of the following topics:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* Topic
    ** No messages should be published on the `cache/a/wis2/#` topic as received by the test MQTT client.
* WNM Messages
    ** No messages should be published on the `cache/a/wis2/#` topic as received by the test MQTT client.
* Data Objects
    ** No data objects should be cached by the GC.
* GC Metrics
    ** The following metrics are updated as expected per the prepared test data set:
        *** `wmo_wis2_gc_download_total` (unchanged)
        *** `wmo_wis2_gc_dataserver_status_flag` (unchanged)
        *** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (unchanged)
        *** `wmo_wis2_gc_cache_override_total` (+=1 for each WNM)
        *** `wmo_wis2_gc_downloaded_errors_total` (unchanged)

===== 7. Data Integrity Check Failure (Recommended)
====== Purpose
A Global Cache should validate the integrity of the resources it caches and only accept data which matches the integrity value from the WIS Notification Message. If the WIS Notification Message does not contain an integrity value, a Global Cache should accept the data as valid. In this case a Global Cache _may_ add an integrity value to the message it republishes.

*Source:* Guide to WIS (WMO No. 1061), Vol II, clause 2.7.4.1. [Global Cache] Technical considerations https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_technical_considerations_2; clause 2.7.4.2. [Global Cache] Practices and procedures https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_practices_and_procedures_2
*Source:* https://github.com/wmo-im/wis2-notification-message/blob/main/standard/recommendations/core/REC_integrity.adoc

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's with:
    *** #invalid# data integrity value (accessed via `properties.integrity.value` and the method specified in `properties.integrity.method`)
    *** `properties.data_id` + `properties.pubtime` should be unique to each message.
  ** Accompanying data objects that are accessible via the canonical link provided in the WNM

====== Steps

. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WNM's to the dev/test GB on one or more of the following topics:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** No messages should be published on the `cache/a/wis2/#` topic as received by the test MQTT client.
* Data Objects
    ** No data objects should be cached by the GC.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (unchanged)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 0 for each)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (unchanged)
    ** `wmo_wis2_gc_downloaded_errors_total` (+=1 for each WNM)
    ** `wmo_wis2_gc_integrity_failed_total` (+=1 for each WNM)

===== 8. WIS2 Notification Message Deduplication
====== Purpose
A Global Cache must ensure that only one instance of a notification message with a given unique identifier (id) is successfully processed.

*Source:* Manual on WIS (WMO No. 1060), Vol II, clause 3.7.5.3: A Global Cache shall subscribe to notifications about the availability of discovery metadata records and core data for real-time or near-real-time exchange. Duplicate notifications are discarded.

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's where:
    *** `properties.data_id` + `properties.pubtime` are #NOT# unique to each message, but shared by 2 or more messages.
  ** Accompanying data objects that are accessible via the canonical link provided in the WNM,

====== Steps
. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WNM's to the dev/test GB on one or more of the following topics:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** Only one message should be published `cache/a/wis2/#` topic per unique identifier which is defined as `properties.data_id` + `properties.pubtime`.
* Data Objects
    ** Only one data object should be cached per unique identifier which is defined as `properties.data_id` + `properties.pubtime`.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (+=1 for each unique identifier)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 1 for each unique identifier)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (set to current for each unique identifier)
    ** `wmo_wis2_gc_downloaded_errors_total` (unchanged)
    ** `wmo_wis2_gc_integrity_failed_total` (unchanged)






===== 8.1. WIS2 Notification Message Deduplication (Alternative 1)

====== Purpose
Where a Global Cache fails to process a notification message relating to a given unique data object (`properties.data_id` + `properties.pubtime`), a Global Cache should successfully process a valid, subsequently received notification message with the same unique data identifier.

*Source:* Manual on WIS (WMO No. 1060), Vol II, clause 3.7.5.3: A Global Cache shall subscribe to notifications about the availability of discovery metadata records and core data for real-time or near-real-time exchange. Duplicate notifications are discarded.

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's where:
    *** `properties.data_id` + `properties.pubtime` are #NOT# unique to each message, but shared by 2 or more messages.
    *** This defines a unique identifier message set.
    *** For each unique identifier message set, the first published message should be invalid, or the data object inaccessible, and the second message/data object should be valid.
  ** Accompanying data objects that are accessible (or not) via the canonical link provided in the WNM.

====== Steps
. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WNM's to the dev/test GB such that the invalid WNM for each unique data identifier is published first. One or more of the following topics can be used:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** Only one message should be received on the `cache/a/wis2/#` topic per unique identifier which is defined as `properties.data_id` + `properties.pubtime`.
* Data Objects
    ** Only one data object should be cached per unique identifier which is defined as `properties.data_id` + `properties.pubtime`.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (+=1 for each unique identifier)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 1 for each unique identifier)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (set to current for each unique identifier)
    ** `wmo_wis2_gc_downloaded_errors_total` (+=1 for each unique identifier WNM message set)
    ** `wmo_wis2_gc_integrity_failed_total` (unchanged)

===== 8.1. WIS2 Notification Message Update (Alternative 2)

====== Purpose
A Global Cache should treat notification messages with the same data item identifier (`properties.data_id`), but different publication times (`properties.pubtime`) as unique data items. Data items with the same `properties.data_id` but a later publication time should be copied into the cache (see test Notification processing). Data items with the same `properties.data_id` but earlier or identical publication times should be ignored (see test Duplicate link discarding).

*Source:* Guide to WIS (WMO No. 1061), Vol II, clause 2.7.4.2. [Global Cache] Practices and procedures: “Verify if the message points to new or updated data by comparing the pubtime value of the notification message with the list of data_ids”. https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_practices_and_procedures_2

====== Requirements
* Dev/test GC MQTT broker connection string
    ** User is able to connect to the GC MQTT broker and subscribe to the `cache/a/wis2/#` topic (readonly)
* Dev/test GB MQTT broker connection string
    ** User is able to publish messages to the dev/test GB on the `origin/a/wis2/#` and `cache/a/wis2/#` topic.
* Dev/test GC is initiated with subscription to the `cache/a/wis2/#` topic and `origin/a/wis2/#` topic of the dev/test GB.
* MQTT test client
    ** Client should connect to both the dev/test GB and GC MQTT brokers using the provided connection strings to control the input and monitor the output.
* GC metrics scraper
* Prepared WIS2 Notification Messages and data objects
  ** A known number *https://github.com/wmo-im/wis2-notification-message[valid]* WNM's where:
    *** `properties.data_id` + `properties.pubtime` are unique to each message, but the properties.data_id is shared by 2 or more messages and the pubtimes are different.
    *** This defines a unique identifier message set.
  ** Accompanying data objects that are accessible via the canonical link provided in the WNM.

====== Steps
. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WNM's to the dev/test GB such for each unique identifier message set, the first published message has a pubtime that is less than the subsequent message/s. One or more of the following topics can be used:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** For each message set with a shared data_id, each message should be processed by the GC and received on the `cache/a/wis2/#` topic assuming that the `properties.pubtime` as been correctly set (increasing) for each message sent in chronological order.
* Data Objects
    ** For each message set with a shared data_id, each data object should be cached by the GC and assuming that the `properties.pubtime` as been correctly set (increasing) for each message sent in chronological order.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (+=1 for each message)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 1)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (set to current)
    ** `wmo_wis2_gc_downloaded_errors_total` (unchanged)
    ** `wmo_wis2_gc_integrity_failed_total` (unchanged)

===== 8.2. WIS2 Notification Message Deduplication (Alternative 3)
====== Purpose
Related to the two previous tests, a GC should not process and cache a data item if it has already processed and cached a data item with the same `properties.data_id` and a `properties.pubtime` that is equal to or less than the `properties.pubtime` of the new data item. This test is an extension of the previous tests and can be conducted in conjunction with them.

====== Requirements
See above.

====== Steps
. Configure the MQTT test client to connect to the dev/test GB and GC MQTT brokers using the provided connection strings.
. Publish the prepared WNM's to the dev/test GB such for each unique identifier message set, the first published message has a pubtime that is #greater than or equal to# the subsequent message/s. One or more of the following topics can be used:
    ** origin/a/wis2/+/data
    ** cache/a/wis2/+/data
    ** origin/a/wis2/+/metadata
    ** cache/a/wis2/+/metadata

====== Evaluate
* WNM Messages
    ** For each message set with a shared data_id, each message should be processed by the GC and received on the `cache/a/wis2/#` topic assuming that the `properties.pubtime` as been correctly set (decreasing or equal) for each message sent in chronological order.
* Data Objects
    ** For each message set with a shared data_id, each data object should be cached by the GC and assuming that the `properties.pubtime` as been correctly set (decreasing or equal) for each message sent in chronological order.
* GC Metrics
    ** `wmo_wis2_gc_download_total` (+=1 for each set of messages sharing the same data_id)
    ** `wmo_wis2_gc_dataserver_status_flag` (set to 1)
    ** `wmo_wis2_gc_dataserver_last_download_timestamp_seconds` (set to current)
    ** `wmo_wis2_gc_downloaded_errors_total` (unchanged)
    ** `wmo_wis2_gc_integrity_failed_total` (unchanged)


==== Performance tests

===== Notification processing rate

====== Purpose
A Global Cache shall be able to successfully process 1000 notification messages, averaging xxx bytes, including caching the associated data item and publishing the new notification message, within xxx seconds.

===== Steps

. step 1
. step 2

===== Notification processing time

====== Purpose
A Global Cache shall successfully process a notification message, including caching the associated data item and publishing the new notification message, within xxx seconds.

Note: A Global Cache may decide to ignore the request to cache a data item if it will take excessively long to process. See test Cache override for details.

===== Steps

. step 1
. step 2

===== Concurrent client downloads

====== Purpose
1000 HTTP clients concurrently download data items from the Global Cache, with HTTP response time not exceeding xxx seconds, at a rate exceeding xxx bytes/second.

*Source:* Manual on WIS (WMO No. 1060), Vol II, clause 3.7.5.5: A Global Cache shall provide highly available access to copies of discovery metadata records and core data it stores; clause 4.5.1: A Global Cache shall operate a highly available storage and download service; clause 4.5.2: A Global Cache shall download core data and discovery metadata from [WIS2 Nodes] and other Global [Services] to provide for reliable, low-latency access to those resources via WIS.
*Source:* Guide to WIS (WMO No. 1061), Vol II, clause 2.7.2.2. Service levels, performance indicators and fair-usage policies: “A Global Cache should support a minimum of 1000 simultaneous downloads” https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_procedure_for_registration_of_a_new_global_service

===== Steps

. step 1
. step 2

===== Storage volume

====== Type of test
Performance

====== Purpose
A Global Cache shall be able to store at least 100GB of Core data items.

*Source:* Guide to WIS (WMO No. 1061), Vol II, clause 2.7.2.2. Service levels, performance indicators and fair-usage policies: “A Global Cache should support a minimum of 100 GB of data in the cache” https://wmo-im.github.io/wis2-guide/guide/wis2-guide-DRAFT.html#_procedure_for_registration_of_a_new_global_service

===== Steps

. step 1
. step 2

==== System-wide tests

===== Single Global Broker failure

====== Purpose
Pre: At least 2 Global Brokers have subscribed to notification messages from a given WIS2 Node.
Pre: Global Cache is subscribed to at least two Global Brokers.
Pre: Global Cache is successfully downloading data items into its cache from the WIS2 Node.

In the event that one of the Global Brokers subscribing to the WIS2 Node fails (i.e., goes offline), notification messages from the WIS2 Node are still received (and processed) by the Global Cache.

===== Steps

. step 1
. step 2

===== Origin node unresolvable

====== Purpose
Pre: A given WIS2 Node is publishing notification messages and Core data.
Pre: At least 2 Global Caches are receiving notification messages from the WIS2 Node (via a Global Broker).
Pre: Global Cache #1 is able to resolve HTTP URLs from the WIS2 Node.
Pre: Global Cache #2 is not able to resolve HTTP URLs from the WIS2 Node.

Core data items published by the WIS2 Node are successfully cached by Global Cache #2, by way of downloading from Global Cache #1.

===== Steps

. step 1
. step 2

==== Considerations

===== General Testing Strategy

The testing strategy for the Global Cache (GC) will leverage both mocked data and prepared real data. This approach ensures a comprehensive evaluation of the GC's functionality under various scenarios.

1. **Prepated Data:** This data is artificially created to simulate specific scenarios that might not be easily reproducible with real data. It allows us to test edge cases, error conditions, and unusual data patterns.

2. **Curated Real Data:** This data is derived from actual use cases and provides a realistic representation of what the GC will encounter in a production environment. It allows us to test the GC's performance and reliability.

The testing process will be automated through scripts. These scripts will perform the following steps:

1. **Data Publication:** The scripts will publish a batch of messages to the dev MQTT broker. These messages will represent a mix of scenarios based on the mocked and prepared real data.

2. **GC Subscription:** The GC will be subscribed to the MQTT broker to receive the published messages. This simulates the GC's real-world operation where it subscribes to Global Brokers to receive notifications. (Remy has something already in the works here)

3. **Result Validation:** After the GC processes the received messages, the scripts will validate the results. This includes checking if the GC correctly stored the data, published notifications, and updated metrics as expected.

===== General Performance Testing Strategy

The performance testing strategy for the GC will primarily focus on the time taken from when a notification message is published to when the associated cache message is received by the test process. This approach ensures a comprehensive evaluation of the GC's performance under various scenarios.

1. **Notification Publication:** The test process will publish a notification message to the MQTT broker. This message will represent a specific scenario based on the mocked or curated real data.

2. **Start Timer:** The test process will start a timer immediately after the notification message is published. Multiple timers can be used for multiple notification messages.

3. **GC Subscription and Processing:** The GC, which is subscribed to the dev MQTT broker, will receive the published notification message. It will then process the message, which may include storing the data, publishing a cache notification, and updating metrics as expected.

4. **Cache Message Receipt:** The test process, which is also subscribed to the MQTT broker, will receive the cache message published by the GC.

5. **Stop Timer:** The test process will stop the timer immediately after the cache message is received.

6. **Result Validation:** The test process will validate the results. This includes checking if the GC correctly processed the notification message and published the cache message, and if the time taken (as measured by the timer) is within the acceptable performance limits.

7. **Data Size Consideration:** The size of the cached data objects will also be considered. The performance of the GC can be evaluated based on the bytes per second processed. This will help in understanding the GC's efficiency in handling different sizes of data objects.


===== Addition of `wmo_wis2_gc_no_cache_total` metric
* This metric will be used to capture `properties.cache=false` cases. It will be incremented by 1 (one) for each notification message where the `properties.cache` property is set to `false` or where the Global Cache determines that it is unable to cache a data item.

===== Message uniqueness = `properties.data_id` + `properties.pubtime`
* The unique identifier of a data item is a combination of the data identifier (`properties.data_id`) and the publication time (`properties.pubtime`). This is to ensure that the Global Cache does not store multiple copies of the same data item AND to support the ability to update/correct data items.

* Are other folks in agreement with this approach and already implementing it?

===== Max data object size
* What is the maximum size of a data object that a Global Cache should be able to process and store?

===== Data Integrity Checks
* How are folks implementing the data integrity check? Downloading first or any other approach, perhaps a rolling hash?

===== Best practices/best effort
====== Retry/Redrive strategy
* Simple: failed download attempts where we retry same URL. (immediate, and/or after a backoff as these solve different problems).
* Redrive based on messages with redundant `properties.data_id`'s in the event of a download failure. This would require caching all messages for a certain amount of time. This way the Global Cache can reprocess the message with the same `properties.data_id` + `properties.pubtime` if the download fails and 'redundant' messages with different download links exist.
    ** supporting update/correction of data items per GTS?
